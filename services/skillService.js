const { prisma } = require('../config/database');
const { ERROR_MESSAGES, SUCCESS_MESSAGES } = require('../utils/constants');

// Habilidades de demonstra√ß√£o (quando n√£o h√° banco de dados)
const demoSkills = [
  // Habilidades T√©cnicas
  { id: '1', name: 'JavaScript', category: 'TECHNICAL', level: 'INTERMEDIATE', description: 'Linguagem de programa√ß√£o JavaScript' },
  { id: '2', name: 'Python', category: 'TECHNICAL', level: 'ADVANCED', description: 'Linguagem de programa√ß√£o Python' },
  { id: '3', name: 'React', category: 'TECHNICAL', level: 'INTERMEDIATE', description: 'Biblioteca React para desenvolvimento web' },
  { id: '4', name: 'Node.js', category: 'TECHNICAL', level: 'INTERMEDIATE', description: 'Runtime JavaScript para backend' },
  { id: '5', name: 'HTML/CSS', category: 'TECHNICAL', level: 'ADVANCED', description: 'Linguagens de marca√ß√£o e estilo' },
  { id: '6', name: 'SQL', category: 'TECHNICAL', level: 'INTERMEDIATE', description: 'Linguagem de consulta estruturada' },
  { id: '7', name: 'Git', category: 'TECHNICAL', level: 'INTERMEDIATE', description: 'Sistema de controle de vers√£o' },
  { id: '8', name: 'Docker', category: 'TECHNICAL', level: 'BEGINNER', description: 'Plataforma de containeriza√ß√£o' },

  // Habilidades de Ensino
  { id: '9', name: 'Ensino de Matem√°tica', category: 'EDUCATION', level: 'ADVANCED', description: 'Ensino de matem√°tica para diferentes n√≠veis' },
  { id: '10', name: 'Ensino de Portugu√™s', category: 'EDUCATION', level: 'ADVANCED', description: 'Ensino de l√≠ngua portuguesa' },
  { id: '11', name: 'Alfabetiza√ß√£o', category: 'EDUCATION', level: 'EXPERT', description: 'Ensino de alfabetiza√ß√£o para adultos' },
  { id: '12', name: 'Ensino de Ingl√™s', category: 'EDUCATION', level: 'INTERMEDIATE', description: 'Ensino de l√≠ngua inglesa' },
  { id: '13', name: 'Educa√ß√£o Especial', category: 'EDUCATION', level: 'ADVANCED', description: 'Ensino para pessoas com necessidades especiais' },
  { id: '14', name: 'Aulas de Refor√ßo', category: 'EDUCATION', level: 'INTERMEDIATE', description: 'Aulas de refor√ßo escolar' },

  // Habilidades de Sa√∫de
  { id: '15', name: 'Primeiros Socorros', category: 'HEALTH', level: 'INTERMEDIATE', description: 'T√©cnicas b√°sicas de primeiros socorros' },
  { id: '16', name: 'Cuidados com Idosos', category: 'HEALTH', level: 'ADVANCED', description: 'Cuidados espec√≠ficos para idosos' },
  { id: '17', name: 'Apoio Psicol√≥gico', category: 'HEALTH', level: 'INTERMEDIATE', description: 'Apoio emocional e psicol√≥gico' },
  { id: '18', name: 'Nutri√ß√£o', category: 'HEALTH', level: 'INTERMEDIATE', description: 'Conhecimentos em nutri√ß√£o e alimenta√ß√£o' },
  { id: '19', name: 'Fisioterapia', category: 'HEALTH', level: 'ADVANCED', description: 'T√©cnicas de fisioterapia b√°sica' },

  // Habilidades Art√≠sticas
  { id: '20', name: 'M√∫sica', category: 'ARTS', level: 'ADVANCED', description: 'Conhecimento musical e instrumentos' },
  { id: '21', name: 'Pintura', category: 'ARTS', level: 'INTERMEDIATE', description: 'T√©cnicas de pintura e arte visual' },
  { id: '22', name: 'Teatro', category: 'ARTS', level: 'INTERMEDIATE', description: 'Arte dram√°tica e interpreta√ß√£o' },
  { id: '23', name: 'Dan√ßa', category: 'ARTS', level: 'ADVANCED', description: 'Diferentes estilos de dan√ßa' },
  { id: '24', name: 'Fotografia', category: 'ARTS', level: 'INTERMEDIATE', description: 'T√©cnicas fotogr√°ficas' },

  // Habilidades Esportivas
  { id: '25', name: 'Futebol', category: 'SPORTS', level: 'ADVANCED', description: 'T√©cnicas e regras do futebol' },
  { id: '26', name: 'Nata√ß√£o', category: 'SPORTS', level: 'INTERMEDIATE', description: 'T√©cnicas de nata√ß√£o' },
  { id: '27', name: 'Artes Marciais', category: 'SPORTS', level: 'ADVANCED', description: 'Diferentes modalidades de artes marciais' },
  { id: '28', name: 'Yoga', category: 'SPORTS', level: 'INTERMEDIATE', description: 'Pr√°ticas de yoga e medita√ß√£o' },
  { id: '29', name: 'Atletismo', category: 'SPORTS', level: 'INTERMEDIATE', description: 'Modalidades de atletismo' },

  // Habilidades de Comunica√ß√£o
  { id: '30', name: 'Orat√≥ria', category: 'COMMUNICATION', level: 'ADVANCED', description: 'T√©cnicas de apresenta√ß√£o e fala em p√∫blico' },
  { id: '31', name: 'Reda√ß√£o', category: 'COMMUNICATION', level: 'ADVANCED', description: 'T√©cnicas de escrita e reda√ß√£o' },
  { id: '32', name: 'Tradu√ß√£o', category: 'COMMUNICATION', level: 'INTERMEDIATE', description: 'Tradu√ß√£o entre idiomas' },
  { id: '33', name: 'Comunica√ß√£o Visual', category: 'COMMUNICATION', level: 'INTERMEDIATE', description: 'Design gr√°fico e comunica√ß√£o visual' },

  // Habilidades Organizacionais
  { id: '34', name: 'Gest√£o de Projetos', category: 'MANAGEMENT', level: 'ADVANCED', description: 'Planejamento e execu√ß√£o de projetos' },
  { id: '35', name: 'Lideran√ßa', category: 'MANAGEMENT', level: 'ADVANCED', description: 'Habilidades de lideran√ßa e coordena√ß√£o' },
  { id: '36', name: 'Organiza√ß√£o de Eventos', category: 'MANAGEMENT', level: 'INTERMEDIATE', description: 'Planejamento e execu√ß√£o de eventos' },
  { id: '37', name: 'Voluntariado', category: 'MANAGEMENT', level: 'EXPERT', description: 'Experi√™ncia em atividades volunt√°rias' },

  // Habilidades Pr√°ticas
  { id: '38', name: 'Constru√ß√£o Civil', category: 'PRACTICAL', level: 'INTERMEDIATE', description: 'T√©cnicas b√°sicas de constru√ß√£o' },
  { id: '39', name: 'Jardinagem', category: 'PRACTICAL', level: 'INTERMEDIATE', description: 'Cuidados com plantas e jardins' },
  { id: '40', name: 'Culin√°ria', category: 'PRACTICAL', level: 'ADVANCED', description: 'T√©cnicas culin√°rias e preparo de alimentos' },
  { id: '41', name: 'Costura', category: 'PRACTICAL', level: 'INTERMEDIATE', description: 'T√©cnicas de costura e reparos' },
  { id: '42', name: 'Mec√¢nica B√°sica', category: 'PRACTICAL', level: 'BEGINNER', description: 'Reparos b√°sicos em equipamentos' }
];

// Verificar se o banco est√° dispon√≠vel
const isDatabaseAvailable = async () => {
  try {
    if (!process.env.DATABASE_URL) {
      return false;
    }
    await prisma.$queryRaw`SELECT 1`;
    return true;
  } catch (error) {
    return false;
  }
};

// Obter todas as habilidades
const getAllSkills = async () => {
  try {
    const dbAvailable = await isDatabaseAvailable();
    
    if (!dbAvailable) {
      return {
        success: true,
        data: demoSkills,
        demo: true
      };
    }

    const skills = await prisma.skill.findMany({
      where: { isActive: true },
      orderBy: [
        { category: 'asc' },
        { name: 'asc' }
      ]
    });

    return {
      success: true,
      data: skills
    };
  } catch (error) {
    return {
      success: true,
      data: demoSkills,
      demo: true
    };
  }
};

// Obter habilidades por categoria
const getSkillsByCategory = async (category) => {
  try {
    const dbAvailable = await isDatabaseAvailable();
    
    if (!dbAvailable) {
      const filteredSkills = demoSkills.filter(skill => skill.category === category);
      return {
        success: true,
        data: filteredSkills,
        demo: true
      };
    }

    const skills = await prisma.skill.findMany({
      where: { 
        isActive: true,
        category: category
      },
      orderBy: { name: 'asc' }
    });

    return {
      success: true,
      data: skills
    };
  } catch (error) {
    return {
      success: true,
      data: demoSkills.filter(skill => skill.category === category),
      demo: true
    };
  }
};

// Buscar habilidades por nome
const searchSkills = async (query) => {
  try {
    const dbAvailable = await isDatabaseAvailable();
    
    if (!dbAvailable) {
      const filteredSkills = demoSkills.filter(skill => 
        skill.name.toLowerCase().includes(query.toLowerCase()) ||
        skill.description.toLowerCase().includes(query.toLowerCase())
      );
      
      return {
        success: true,
        data: filteredSkills,
        demo: true
      };
    }

    const skills = await prisma.skill.findMany({
      where: {
        isActive: true,
        OR: [
          { name: { contains: query, mode: 'insensitive' } },
          { description: { contains: query, mode: 'insensitive' } }
        ]
      },
      orderBy: { name: 'asc' }
    });

    return {
      success: true,
      data: skills
    };
  } catch (error) {
    return {
      success: true,
      data: demoSkills.filter(skill => 
        skill.name.toLowerCase().includes(query.toLowerCase()) ||
        skill.description.toLowerCase().includes(query.toLowerCase())
      ),
      demo: true
    };
  }
};

// Obter categorias de habilidades
const getSkillCategories = async () => {
  const categories = [
    { id: 'TECHNICAL', name: 'T√©cnicas', description: 'Habilidades t√©cnicas e tecnol√≥gicas', icon: 'üíª', color: '#3498db' },
    { id: 'EDUCATION', name: 'Educa√ß√£o', description: 'Habilidades relacionadas ao ensino', icon: 'üéì', color: '#2ecc71' },
    { id: 'HEALTH', name: 'Sa√∫de', description: 'Habilidades na √°rea da sa√∫de', icon: 'üè•', color: '#e74c3c' },
    { id: 'ARTS', name: 'Artes', description: 'Habilidades art√≠sticas e criativas', icon: 'üé®', color: '#9b59b6' },
    { id: 'SPORTS', name: 'Esportes', description: 'Habilidades esportivas e f√≠sicas', icon: '‚öΩ', color: '#f39c12' },
    { id: 'COMMUNICATION', name: 'Comunica√ß√£o', description: 'Habilidades de comunica√ß√£o', icon: 'üí¨', color: '#1abc9c' },
    { id: 'MANAGEMENT', name: 'Gest√£o', description: 'Habilidades de lideran√ßa e gest√£o', icon: 'üë•', color: '#34495e' },
    { id: 'PRACTICAL', name: 'Pr√°ticas', description: 'Habilidades pr√°ticas e manuais', icon: 'üîß', color: '#e67e22' }
  ];

  return {
    success: true,
    data: categories,
    demo: true
  };
};

// Obter n√≠veis de habilidade
const getSkillLevels = async () => {
  const levels = [
    { id: 'BEGINNER', name: 'Iniciante', description: 'Conhecimento b√°sico', color: '#95a5a6' },
    { id: 'INTERMEDIATE', name: 'Intermedi√°rio', description: 'Conhecimento intermedi√°rio', color: '#f39c12' },
    { id: 'ADVANCED', name: 'Avan√ßado', description: 'Conhecimento avan√ßado', color: '#e74c3c' },
    { id: 'EXPERT', name: 'Especialista', description: 'Conhecimento especializado', color: '#8e44ad' }
  ];

  return {
    success: true,
    data: levels,
    demo: true
  };
};

// Obter habilidades populares
const getPopularSkills = async (limit = 10) => {
  try {
    const dbAvailable = await isDatabaseAvailable();
    
    if (!dbAvailable) {
      // Simular habilidades populares baseadas em uso
      const popularSkills = demoSkills
        .sort((a, b) => Math.random() - 0.5)
        .slice(0, limit);
      
      return {
        success: true,
        data: popularSkills,
        demo: true
      };
    }

    const skills = await prisma.skill.findMany({
      where: { isActive: true },
      include: {
        _count: {
          select: {
            volunteers: true
          }
        }
      },
      orderBy: {
        volunteers: {
          _count: 'desc'
        }
      },
      take: limit
    });

    return {
      success: true,
      data: skills
    };
  } catch (error) {
    return {
      success: true,
      data: demoSkills.slice(0, limit),
      demo: true
    };
  }
};

// Obter estat√≠sticas das habilidades
const getSkillStats = async () => {
  try {
    const dbAvailable = await isDatabaseAvailable();
    
    if (!dbAvailable) {
      // Estat√≠sticas simuladas
      const stats = {
        totalSkills: demoSkills.length,
        skillsByCategory: demoSkills.reduce((acc, skill) => {
          acc[skill.category] = (acc[skill.category] || 0) + 1;
          return acc;
        }, {}),
        skillsByLevel: demoSkills.reduce((acc, skill) => {
          acc[skill.level] = (acc[skill.level] || 0) + 1;
          return acc;
        }, {}),
        mostPopular: demoSkills.slice(0, 5).map(skill => skill.name)
      };
      
      return {
        success: true,
        data: stats,
        demo: true
      };
    }

    const totalSkills = await prisma.skill.count({
      where: { isActive: true }
    });

    const skillsByCategory = await prisma.skill.groupBy({
      by: ['category'],
      where: { isActive: true },
      _count: true
    });

    const skillsByLevel = await prisma.skill.groupBy({
      by: ['level'],
      where: { isActive: true },
      _count: true
    });

    return {
      success: true,
      data: {
        totalSkills,
        skillsByCategory: skillsByCategory.reduce((acc, item) => {
          acc[item.category] = item._count;
          return acc;
        }, {}),
        skillsByLevel: skillsByLevel.reduce((acc, item) => {
          acc[item.level] = item._count;
          return acc;
        }, {})
      }
    };
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
};

module.exports = {
  getAllSkills,
  getSkillsByCategory,
  searchSkills,
  getSkillCategories,
  getSkillLevels,
  getPopularSkills,
  getSkillStats
};


